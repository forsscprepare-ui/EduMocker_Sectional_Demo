<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EduMocker Test</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{margin:0;background:#f4f6f8;padding:0}
.loader{height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center}
.circle{width:70px;height:70px;border:7px solid #ddd;border-top:7px solid #2c5364;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.hidden{display:none}
.header{background:#fff;padding:12px;display:flex;justify-content:space-between;border-bottom:1px solid #ddd}
.container{padding:14px}
button{padding:12px;border:none;border-radius:10px;background:#2c5364;color:#fff;font-size:15px;cursor:pointer}
button:disabled{opacity:.4}
.q-inst{font-size:14px}
.question{font-weight:bold;margin:8px 0}
.option{background:#fff;border:1px solid #ccc;padding:12px;border-radius:10px;margin-bottom:10px;cursor:pointer}
.option.selected{background:#e8f1f5;border-color:#2c5364}
.nav{display:flex;justify-content:space-between;margin:10px 0}
.grid{display:flex;flex-wrap:wrap;gap:6px}
.grid div{width:32px;height:32px;border:1px solid #2c5364;display:flex;align-items:center;justify-content:center;cursor:pointer}
.grid .attempted{background:#2c5364;color:#fff;border-radius:50%}
.score{padding:16px}
.card{background:#fff;padding:12px;border-radius:12px;margin-bottom:10px}
.filter{display:flex;gap:6px;margin-top:10px}
.filter button{flex:1;background:#ccc;color:#000}
.filter .active{background:#2c5364;color:#fff}
.popup{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;justify-content:center;align-items:center}
.popup-box{background:#fff;padding:18px;border-radius:14px;width:85%;text-align:center}
</style>
</head>
<body>

<div id="loader" class="loader">
  <div class="circle"></div>
  <p>Checking user…</p>
</div>

<div id="instruction" class="hidden container">
  <h3>Instructions</h3>
  <ul>
    <li>Time: 15 Minutes</li>
    <li>Negative Marking: 0.25 per wrong answer</li>
    <li>Submit anytime</li>
  </ul>
  <button onclick="startTest()">Start Test</button>
</div>

<div id="test" class="hidden">
  <div class="header">
    <b>EduMocker Demo Test</b>
    <span id="timer">15:00</span>
  </div>
  <div class="container">
    <div class="q-inst">Choose the correct answer</div>
    <div class="question" id="question"></div>
    <div id="options"></div>

    <div class="nav">
      <button id="prevBtn" onclick="prevQ()">Previous</button>
      <button id="nextBtn" onclick="nextQ()">Next</button>
    </div>

    <div class="grid" id="grid"></div>
    <br>
    <button onclick="submitTest()">Submit Test</button>
  </div>
</div>

<div id="score" class="hidden score">
  <h3>EduMocker Demo Test</h3>
  <p id="userScore"></p>
  <div class="card" id="stats"></div>

  <div class="filter">
    <button class="active" onclick="filterQ('all',this)">All</button>
    <button onclick="filterQ('correct',this)">Correct</button>
    <button onclick="filterQ('wrong',this)">Wrong</button>
    <button onclick="filterQ('unattempted',this)">Unattempted</button>
  </div>

  <div id="review"></div>
  <br>
  <button onclick="reattempt()">Reattempt</button>
</div>

<div class="popup" id="popup">
  <div class="popup-box">
    <p>Your previous score & rank will be replaced.</p>
    <button onclick="confirmReattempt()">OK</button>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDC7bCtLbGiU-4ZEfXvLbzU0jXkeHUlgG4",
  authDomain: "test-fdc3c.firebaseapp.com",
  projectId: "test-fdc3c"
});
const db = firebase.firestore();

const TEST_ID = "GK_Set_2";
const STORAGE_KEY = "RESULT_" + TEST_ID;
const TEST_DURATION_MINUTES = 15;
const NEGATIVE_MARK = 0.25;

const user = {
  phone: localStorage.getItem("user_phone"),
  name: localStorage.getItem("user_name")
};
if(!user.phone){ alert("Login required"); throw ""; }

const questions = [
 {q:"2 + 2 = ?", o:["1","2","3","4"], a:3},
 {q:"Capital of India?", o:["Delhi","Mumbai","Chennai","Kolkata"], a:0},
 {q:"5 × 3 = ?", o:["10","15","20","25"], a:1}
];

let answers={}, index=0, timeLeft, timerInt;

window.onload=()=>{
  const saved=localStorage.getItem(STORAGE_KEY);
  saved?showScore(JSON.parse(saved)):(loader.classList.add("hidden"),instruction.classList.remove("hidden"));
};

function startTest(){
  instruction.classList.add("hidden");
  test.classList.remove("hidden");
  timeLeft=TEST_DURATION_MINUTES*60;
  timerInt=setInterval(runTimer,1000);
  buildGrid();loadQ();
}

function runTimer(){
  if(timeLeft<=0){submitTest();return;}
  timeLeft--;
  timer.innerText=`${String(Math.floor(timeLeft/60)).padStart(2,"0")}:${String(timeLeft%60).padStart(2,"0")}`;
}

function loadQ(){
  const q=questions[index];
  question.innerText=q.q;
  options.innerHTML="";
  q.o.forEach((t,i)=>{
    const d=document.createElement("div");
    d.className="option"+(answers[index]===i?" selected":"");
    d.innerText=t;
    d.onclick=()=>{answers[index]=answers[index]===i?null:i;loadQ();updateGrid();};
    options.appendChild(d);
  });
  prevBtn.disabled=index===0;
  nextBtn.disabled=index===questions.length-1;
}

function nextQ(){index++;loadQ();}
function prevQ(){index--;loadQ();}

function buildGrid(){
  grid.innerHTML="";
  questions.forEach((_,i)=>{
    const d=document.createElement("div");
    d.innerText=i+1;
    d.onclick=()=>{index=i;loadQ();};
    grid.appendChild(d);
  });
}

function updateGrid(){
  [...grid.children].forEach((d,i)=>d.classList.toggle("attempted",answers[i]!=null));
}

function submitTest(){
  clearInterval(timerInt);
  test.classList.add("hidden");
  loader.classList.remove("hidden");
  loader.querySelector("p").innerText="Saving score & calculating rank…";

  let correct=0,wrong=0;
  questions.forEach((q,i)=>{
    if(answers[i]==null)return;
    answers[i]===q.a?correct++:wrong++;
  });

  const score=+(correct-wrong*NEGATIVE_MARK).toFixed(2);

  const baseData={
    phone:user.phone,
    name:user.name,
    score,correct,wrong,
    unattempted:questions.length-correct-wrong,
    updatedAt:Date.now()
  };

  db.collection("tests").doc(TEST_ID).collection("results").doc(user.phone)
  .set(baseData,{merge:true})
  .then(()=>calculateRank(baseData));
}

function calculateRank(myData){
  db.collection("tests").doc(TEST_ID).collection("results").get()
  .then(snap=>{
    const arr=snap.docs.map(d=>({...d.data(),id:d.id}));
    arr.sort((a,b)=>b.score-a.score);
    const rank=arr.findIndex(x=>x.id===user.phone)+1;
    myData.rankText=`${rank} / ${arr.length}`;
    myData.answers=answers;
    localStorage.setItem(STORAGE_KEY,JSON.stringify(myData));
    showScore(myData);
  });
}

function showScore(r){
  loader.classList.add("hidden");
  score.classList.remove("hidden");
  userScore.innerText=`Hi ${r.name}, your score is ${r.score}`;
  stats.innerHTML=`Correct: ${r.correct}<br>Wrong: ${r.wrong}<br>Unattempted: ${r.unattempted}<br><b>Rank: ${r.rankText}</b>`;
  filterQ("all",document.querySelector(".filter button"));
}

function filterQ(type,btn){
  document.querySelectorAll(".filter button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  review.innerHTML="";
  questions.forEach((q,i)=>{
    const a=answers[i];
    if(type==="correct"&&a!==q.a)return;
    if(type==="wrong"&&(a==null||a===q.a))return;
    if(type==="unattempted"&&a!=null)return;
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`<b>${q.q}</b><br>Your: ${a!=null?q.o[a]:"—"}<br>Correct: ${q.o[q.a]}`;
    review.appendChild(c);
  });
}

function reattempt(){popup.style.display="flex";}
function confirmReattempt(){localStorage.removeItem(STORAGE_KEY);location.reload();}
</script>
</body>
</html>
